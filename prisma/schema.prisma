// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// NextAuth models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]
  layouts       Layout[]
  paintTemplates PaintTemplateCustom[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Custom models for Joe-verlay
model Layout {
  id        String   @id @default(cuid())
  userId    String
  sessionId String   @unique
  name      String   @default("My Layout")

  // Overlay settings
  colorScheme    String   @default("default")
  customColors   String?  // JSON string of CustomColors
  fontFamily     String   @default("Inter") // Google Font name
  weatherEffect  String   @default("rain")

  // Scene layers visibility
  weatherVisible        Boolean @default(true)
  chatVisible           Boolean @default(true)
  nowPlayingVisible     Boolean @default(true)
  countdownVisible      Boolean @default(true)
  chatHighlightVisible  Boolean @default(true)
  paintByNumbersVisible Boolean @default(true)
  eventLabelsVisible    Boolean @default(true)

  // Component layouts (JSON) - stores position, size, styling for each component
  componentLayouts String? @default("{\"chat\":{\"position\":\"top-left\",\"x\":0,\"y\":80,\"maxWidth\":400},\"nowPlaying\":{\"position\":\"top-left\",\"x\":0,\"y\":0,\"width\":400},\"countdown\":{\"position\":\"top-left\",\"x\":0,\"y\":0,\"scale\":1},\"weather\":{\"density\":1},\"paintByNumbers\":{\"position\":\"top-left\",\"x\":0,\"y\":0,\"scale\":1,\"gridSize\":20}}")

  // Paint by numbers state (JSON) - stores current painting progress
  paintByNumbersState String? // JSON string of PaintByNumbersState

  // Event labels (JSON) - stores latest follower, sub, bits, etc.
  eventLabelsData String? // JSON: { latestFollower: string, latestSub: string, latestBits: { username: string, amount: number }, etc. }

  // Stream stats & goals
  streamStatsConfig String? // JSON: { followerGoal: number, subGoal: number, bitsGoal: number, showMetrics: string[], resetOnStream: boolean }
  streamStatsData   String? // JSON: { currentFollowers: number, currentSubs: number, currentBits: number, totalMessages: number, startTime: string, messagesPerMinute: number }
  streamStatsVisible Boolean @default(true)

  // Custom background
  backgroundImageUrl      String?   // Cloudinary URL
  backgroundImagePublicId String?   // Cloudinary public_id for deletion
  backgroundImageName     String?   // Original filename for display
  backgroundColors        String?   // JSON: { palette: string[], primary: string, secondary: string, accent: string }
  backgroundOpacity       Float?    @default(1.0) // 0.0 to 1.0
  backgroundBlur          Int?      @default(0)   // 0 to 20px
  backgroundUploadedAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user       User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  countdowns CountdownTimer[]
  alerts     AlertConfig[]
}

model CountdownTimer {
  id          String   @id @default(cuid())
  layoutId    String
  title       String
  description String?
  targetDate  DateTime
  isActive    Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  layout Layout @relation(fields: [layoutId], references: [id], onDelete: Cascade)
}

model AlertConfig {
  id        String   @id @default(cuid())
  layoutId  String

  // Event type: 'follow', 'sub', 'bits', 'raid', 'giftsub'
  eventType String

  // Visual settings
  enabled         Boolean @default(true)
  imageUrl        String? // Cloudinary URL for alert image/gif
  imagePublicId   String? // Cloudinary public_id for deletion
  animationType   String  @default("slide-down") // 'slide-down', 'slide-up', 'bounce', 'fade', 'zoom'
  duration        Int     @default(5) // seconds
  position        String  @default("top-center") // 'top-left', 'top-center', 'top-right', 'center', 'bottom-left', 'bottom-center', 'bottom-right'

  // Audio settings
  soundUrl      String? // Cloudinary URL for alert sound
  soundPublicId String? // Cloudinary public_id for deletion
  volume        Float   @default(0.7) // 0.0 to 1.0

  // Message template
  messageTemplate String  @default("{username} just {event}!") // {username}, {event}, {amount}, {count}

  // Font and color customization
  fontSize      Int     @default(32) // pixels
  textColor     String  @default("#FFFFFF")
  textShadow    Boolean @default(true)
  showBackground Boolean @default(true) // Show/hide alert background box

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  layout Layout @relation(fields: [layoutId], references: [id], onDelete: Cascade)

  @@unique([layoutId, eventType])
}

model PaintTemplateCustom {
  id          String   @id @default(cuid())
  userId      String

  name        String
  description String?
  width       Int      // Grid width
  height      Int      // Grid height
  regions     String   @db.Text // JSON stringified array of PaintRegion objects

  // Cloudinary storage
  imageUrl        String  // Original image URL
  imagePublicId   String  // For deletion
  thumbnailUrl    String? // Preview thumbnail (200x200)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Chatter {
  id               String   @id @default(cuid())
  sessionId        String
  username         String
  displayName      String?  // Twitch display name (may differ from username)

  // Message stats
  messageCount     Int      @default(0)

  // Sentiment tracking
  totalSentiment   Float    @default(0)    // Sum of all sentiment scores
  averageSentiment Float    @default(0)    // totalSentiment / messageCount
  positiveMessages Int      @default(0)    // Count of positive messages
  negativeMessages Int      @default(0)    // Count of negative messages
  neutralMessages  Int      @default(0)    // Count of neutral messages

  // Timestamps
  firstMessageAt   DateTime @default(now())
  lastMessageAt    DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sessionId, username])
  @@index([sessionId, averageSentiment])
  @@index([sessionId, messageCount])
}
